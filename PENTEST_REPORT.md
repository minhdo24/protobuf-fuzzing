## Pentest Fuzzing Protobuf/gRPC Decode – Phase 3

### 1) Scope & Goal
- **Goal**: Verify resilience of Protobuf parse/serialize layer for all message types in `api.proto`, `realtime.proto` (and `apigrpc.proto` when dependency is available), including: wire-format (`proto.Unmarshal`), JSON mapping (`protojson`), `UnmarshalOptions`, gRPC frame (length-prefixed frame) and race-safety on `dynamicpb`.
- **Message scope**: Loaded dynamically from `descriptor_set.pb` (no hardcode struct Go). Any message in descriptor is included in fuzz strategy.
- **Outside scope**: Application logic/server-side service; fuzz black-box via HTTP/gRPC at business layer will be proposed in phase 3.

### 2) Environment & Artefacts
- OS: macOS 13 (darwin 23.3.0)
- Go native fuzz (Go >= 1.18)
- Descriptor builder: `fuzz/build_descriptors.sh`
- Fuzz harness: `fuzz/fuzz_dynamic_unmarshal_test.go`
- Report: this file `fuzz/PENTEST_REPORT.md`

Note: `apigrpc.proto` requires `protoc-gen-openapiv2/options/annotations.proto`. Currently no vendor for that package, so the build script automatically skips `apigrpc.proto` to avoid blocking fuzz (see build log). When adding vendor `grpc-gateway` v2, we will include it to increase coverage.

### 3) Test Methodology
- **Dynamic descriptor registry**: Load `FileDescriptorSet` → collect all `MessageDescriptor` → create `dynamicpb.Message` for each type when fuzz.
- **Message selection strategy**: Combine `idx` with entropy from data to evenly cover between message types (avoid engine under-diversifying `idx`).
- **Fuzzers implemented**:
  - `Fuzz_DynamicUnmarshal`: Fuzz wire-format (`proto.Unmarshal`) + 2 round-trip `Unmarshal → Marshal → Unmarshal → Marshal` to catch subtle inconsistency.
  - `Fuzz_UnmarshalOptions`: Try all combinations `{DiscardUnknown, AllowPartial}` in `proto.UnmarshalOptions`.
  - `Fuzz_DynamicProtoJSON`: Fuzz JSON mapping by `protojson` in two modes (strict/loose unknown, emit/unpopulated) and round-trip.
  - `Fuzz_GRPCFrameDecode`: Fuzz gRPC layer (1 byte compressed flag + 4 bytes big-endian length + payload). Currently not decompressing to avoid outside scope.
  - Stress concurrently: With valid data, perform `Clone`/`Merge`/`Marshal` in independent goroutines to catch race/edge condition.
- **DoS control**: Skip input > 1MiB; recover panic; skip frame with length exceeds buffer; avoid infinite recursion.
- **Corpus/Seeds**: Seed basic for varint/length-delimited/empty. Recommend adding real samples from staging/prod to `testdata/fuzz/...` to improve efficiency.

### 4) Real-world Result (smoke run ~10–12s each fuzzer)
Run quickly to filter out crash/panic clearly. No crash/panic found in all 4 fuzzers.

- `Fuzz_DynamicUnmarshal` (wire-format)
  - Execs ~706k / 12.26s; inputs “interesting” increased: 372
  - No panic, no marshal error after round-trip

- `Fuzz_UnmarshalOptions`
  - Execs ~695k / 11.15s; “interesting”: 229
  - `Unmarshal` error is accepted as normal with malformed data; no marshal error after successful parse

- `Fuzz_DynamicProtoJSON`
  - Execs ~519k / 11.16s; “interesting”: 263
  - With JSON malformed/unknown field: strict fail switch to loose; no crash

- `Fuzz_GRPCFrameDecode`
  - Execs ~1.21M / 11.15s; “interesting”: 223
  - Skip frames with length > buffer; payload parse successfully without error

Overall: No crash/panic found in short time. This is a positive signal for the stability of parse/serialize layer with malicious data in smoke test.

### 5) Analysis & Security Value
- **Data integrity**: Two round-trip makes it more likely to find subtle serialize/deserialization error. No inconsistency.
- **Resilience to malformed input**: `proto.Unmarshal` and `protojson` respond with safe error, not leading to panics.
- **Simultaneous safety**: No error or panic in concurrent clone/merge/marshal on dynamic messages. This reduces race risk at core layer when receiving malicious data.
- **gRPC layer**: Safe length-prefix (no read out of bounds). Currently not checking compression (need plugin/codec). No abnormal behavior with valid payload.

### 6) Limitation & Expansion (suggested)
- Not fuzzing APIs with `openapiv2` dependency in `apigrpc.proto` due to missing vendor. Suggest vendor `grpc-gateway` v2 or specify `-I` to increase coverage.
- Not fuzzing compressed payload (compressed flag = 1) because outside current scope; can add mock codec to find edge-case in decompressor.
- Short fuzz time (10–12s) only for smoke test. Suggest running longer (overnight/CI) to find rare issues.
- No official coverage measurement by `go tool covdata`. Can supplement to optimize corpus by message types less hit.
- Real corpus is not added to `testdata/fuzz/...`. Suggest adding real samples to help quickly cover complex decode branches.

### 7) Suggested Actions (priority)
1. Vendor `protoc-gen-openapiv2` (grpc-gateway v2) into `fuzz/_third_party` to include `apigrpc.proto`.
2. Add real corpus to `testdata/fuzz/Fuzz_*` (hide sensitive data if any).
3. Set up CI job to run fuzz for long time (≥2h), save corpus/crash minimization artifacts.
4. Enable log `FUZZ_LIST_TYPES=1` in some periodic runs to track message types less accessed.
5. Consider adding more control for recursion depth and timeouts for deeply nested messages.
6. If service accepts public JSON, consider hardening schema/validation before parsing to catch malformed JSON early.

### 8) How to reproduce
```bash
# 1) Build descriptor (skip apigrpc.proto if missing openapiv2 vendor)
cd fuzz
./build_descriptors.sh

# 2) Run fuzz short (each fuzzer ~10s)
go test -run TestNonExist -fuzz=Fuzz_DynamicUnmarshal    -fuzztime=10s ./...
go test -run TestNonExist -fuzz=Fuzz_UnmarshalOptions    -fuzztime=10s ./...
go test -run TestNonExist -fuzz=Fuzz_DynamicProtoJSON    -fuzztime=10s ./...
go test -run TestNonExist -fuzz=Fuzz_GRPCFrameDecode     -fuzztime=10s ./...

# (Optional) List loaded message types
FUZZ_LIST_TYPES=1 go test -run TestNonExist -fuzz=Fuzz_DynamicUnmarshal -fuzztime=3s ./...
```

### 9) Conclusion
- Harness has been upgraded to cover key decode surfaces (wire-format, JSON mapping, unmarshal options, gRPC frame) and stress concurrently.
- Smoke run did not find crash/panic. Suggest running longer and supplement vendor to expand coverage (especially `apigrpc.proto`).
- This test significantly improves the reliability of the parse/serialize layer before malicious data, contributing to reducing DoS/crash and logic errors due to inconsistent parsing.


